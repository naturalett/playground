name: Docker Image CI
on: [push]

jobs:
  docker:
    name: Docker build and push
    runs-on: ubuntu-latest
    steps:
    - name: Notify slack3
      uses: actions/hello-world-javascript-action@master
      with:
        run: |
          STARS=$(curl --silent 'https://api.github.com/repos/layer5io/meshery' -H 'Accept: application/vnd.github.preview' | jq '.watchers_count')
        args: '{\"channel\":\"CSK7N9TGX\",\"text\":\"Someone just starred Meshery! (https://github.com/layer5io/meshery/stargazers) Total stars: $STARS\"}'
        command: echo "Now at $STAR stars."
    - name: Get current star count
      id: starcount
      run: |
        echo ::set-env name=STARS::$(curl --silent 'https://api.github.com/repos/layer5io/meshery' -H 'Accept: application/vnd.github.preview' | jq '.watchers_count'):
    - name: Notify slack
      uses: actions/hello-world-javascript-action@master
      with:
        args: '{\"channel\":\"CSK7NF9T8GXA\",\"text\":\"Someone just starred Meshery! (https://github.com/layer5io/meshery/stargazers) Total stars: ${{env.STARS}}\"}'
    - name: Notify slack2
      id: pullreminder2
      run: |
        echo '{\"channel\":\"CSK7NF9T8GXA\",\"text\":\"Someone just starred Meshery! (https://github.com/layer5io/meshery/stargazers) Total stars: ${{env.STARS}}\"}'
    - name: Check out code
      if: github.event_name != 'pull_request' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/master') && success()
      uses: actions/checkout@master
      with:
        fetch-depth: 1
    - name: Login to DockerHub Registry
      if: success() && startsWith(github.ref, 'refs/tags/')
      uses: azure/docker-login@v1
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    - name: Docker build & push
      if: success() && startsWith(github.ref, 'refs/tags/')
      run: |
        DOCKER_BUILDKIT=1 docker build --no-cache -t ${{ secrets.IMAGE_NAME }} -f envoy/Dockerfile .
        docker push ${{ secrets.IMAGE_NAME }}:latest
